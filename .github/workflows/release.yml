name: Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release Version (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.push_branch.outputs.branch_name }}
      release_version: ${{ github.event.inputs.release_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update gradle.properties
        run: |
          sed -i "s/^version=.*/version=${{ github.event.inputs.release_version }}/" gradle.properties

      - name: Push Release Branch
        id: push_branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="release/v${{ github.event.inputs.release_version }}"
          git checkout -b $BRANCH_NAME

          git add gradle.properties
          git commit -m "chore: [bot] bump version to ${{ github.event.inputs.release_version }}"
          git push origin $BRANCH_NAME

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.branch_name }}

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm-community'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Make Gradlew executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Build Native Image (Windows)
        if: runner.os == 'Windows'
        run: .\gradlew.bat nativeCompile

      - name: Build Native Image (Unix)
        if: runner.os != 'Windows'
        run: ./gradlew nativeCompile

      - name: Build Distribution (Linux only)
        if: runner.os == 'Linux'
        run: ./gradlew assembleDist

      - name: Prepare Artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          mv build/native/nativeCompile/jack jack-linux-x64

      - name: Prepare Artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Move-Item -Path "build/native/nativeCompile/jack.exe" -Destination "jack-windows-x64.exe"

      - name: Prepare Artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          mv build/native/nativeCompile/jack jack-macos-x64

      - name: Upload Native Image (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-x64
          path: jack-linux-x64

      - name: Upload Native Image (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: native-windows-x64
          path: jack-windows-x64.exe

      - name: Upload Native Image (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: native-macos-x64
          path: jack-macos-x64

      - name: Upload Distribution (Linux only)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: distribution
          path: build/distributions/*.zip

  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.branch_name }}

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.release_version }}
          name: v${{ needs.prepare.outputs.release_version }}
          body: "Automated release for version ${{ needs.prepare.outputs.release_version }}"
          draft: false
          prerelease: false
          files: |
            artifacts/*
          generate_release_notes: true
          make_latest: true
          target_commitish: ${{ needs.prepare.outputs.branch_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --title "chore: [bot] release v${{ needs.prepare.outputs.release_version }}" \
            --body "Automated release for version ${{ needs.prepare.outputs.release_version }}" \
            --base main --head ${{ needs.prepare.outputs.branch_name }}